<?phpdefine('IN_ECS', true);@set_time_limit(300);require('./data/config.php');require('./includes/cls_mysql.php');$db = new cls_mysql($db_host, $db_user, $db_pass, $db_name);//shopnc数据导入小京东多城市多仓库/*//商品品牌表$sql = "insert into ecs_brand (brand_id,brand_name,brand_logo,brand_desc,site_url,sort_order) SELECT brand_id,brand_name,brand_pic,brand_class,'http://',50 from shopnc_brand";$db->query($sql);//导入商品分类表数据//顶级一级分类$sql = "insert into ecs_category (cat_name,parent_id,sort_order,keywords,cat_desc,category_index,brand_qq,path_name) SELECT gc_name,gc_parent_id,gc_sort,gc_keywords,gc_description,1,gc_id,gc_parent_id from shopnc_goods_class where gc_parent_id = 0"; $db->query($sql);insert_category(1);//递归导入分类下的子类function insert_category($level,$gc_parent_id=0){	global $db;	$nextlevel = $level+1;	$and = '';	if($gc_parent_id>0){		$and = " and gc.gc_parent_id=".$gc_parent_id;	}	$sql = "		SELECT gc.gc_name,gc.gc_parent_id,gc.gc_sort,gc.gc_keywords,gc.gc_description,c.cat_id,gc.gc_id,gc.gc_parent_id from shopnc_goods_class as gc right JOIN ecs_category as c on gc.gc_parent_id = c.brand_qq where c.category_index=".$level.$and." order by c.cat_id;		";		$info = $db->getAll($sql);		//file_put_contents('./'.$level.'.txt',var_export($info,true));				if(count($info)>0){			foreach($info as $key=>$val){				$sql = "insert into ecs_category (cat_name,parent_id,sort_order,keywords,cat_desc,category_index,brand_qq,path_name) SELECT gc_name,".$val['cat_id'].",gc_sort,gc_keywords,gc_description,".$nextlevel.",gc_id,gc_parent_id	 from shopnc_goods_class where gc_id = ".$val['gc_id'];				$db->query($sql);				if(is_have_child($val['gc_id'])){					insert_category($nextlevel,$val['gc_id']);				}			}		}}//判断是否还有子元素function is_have_child($gcid){	global $db;	$sql = "select count(gc_id) from shopnc_goods_class where gc_parent_id=".$gcid;	$num = $db->getOne($sql);	return $num>0 ? true : false;}//导入商品表$sql = "insert into ecs_goods (goods_id,cat_id,goods_sn,goods_name,brand_id,click_count,goods_number,market_price,shop_price,promote_price,add_time,last_update,goods_thumb,goods_img,original_img,is_on_sale) SELECT goods_id,gc_id,'EC0000',goods_name,brand_id,goods_click,goods_storage,goods_marketprice,goods_price,goods_promotion_price,goods_addtime,goods_edittime,goods_image,goods_image,goods_image,goods_state  FROM shopnc_goods";$db->query($sql);//将部分数据原原本本插入进来$sql = "select goods_id,cat_id,goods_sn,goods_thumb,goods_img,original_img from ecs_goods";$query = $db->query($sql);while($row = $db->fetchRow($query)){	$update = array();	$update['cat_id'] = get_new_catid($row['cat_id']);	$update['goods_sn'] = 'ECS' . str_repeat('0', 6 - strlen($row['goods_id'])) . $row['goods_id'];		$ret = move_pic($row['goods_img']);		$update['goods_thumb'] = 'images/201508/thumb_img/'.$ret['goods_thumb'];	$update['goods_img'] = 'images/201508/goods_img/'.$ret['goods_img'];	$update['original_img'] = 'images/201508/source_img/'.$ret['original_img'];	echo $row['goods_id']."<br>";	$db->autoExecute('ecs_goods', $update, 'UPDATE', "goods_id = ".$row['goods_id']);}echo "end";//将导数据中用到的辅助字段的值恢复默认值//$sql = "update ecs_category set category_index =0,brand_qq='',path_name='' WHERE 1";//$db->query($sql);function get_new_catid($cat_id){	global $db;	$sql = "select cat_id from ecs_category where brand_qq='".$cat_id."' limit 1";	return $db->getOne($sql);}function move_pic($picname){	$ret = array('goods_thumb'=>'','goods_img'=>'','original_img'=>'');	$info = explode('_',$picname);	$dir_num = $info[0];	$names = explode('.',$picname);	$pic_ext = array('','_1280','_360','_240','_60');	$path = dirname(__FILE__);	$path_source = $path.'/images/201507/'.$dir_num.'/';//要转移的图片路径	$path_to = $path.'/images/201508/';//要到的位置	//判断原图是否存在	if(is_file($path_source.$picname)){		$ret['original_img'] = $picname;	}else{		if(is_file($path_source.$names[0].'_1280.'.$names[1])){			$ret['original_img'] = $names[0].'_1280.'.$names[1];		}else{			if(is_file($path_source.$names[0].'_360.'.$names[1])){				$ret['original_img'] = $names[0].'_360.'.$names[1];			}else{				$ret['original_img'] = $names[0].'_240.'.$names[1];			}		}	}	@copy($path_source.$ret['original_img'],$path_to.'source_img/'.$ret['original_img']);	$ret['goods_thumb'] = $names[0].'_240.'.$names[1];	@copy($path_source.$ret['goods_thumb'],$path_to.'thumb_img/'.$ret['goods_thumb']);	if(is_file($path_source.$names[0].'_360.'.$names[1])){		$ret['goods_img'] = $names[0].'_360.'.$names[1];		@copy($path_source.$ret['goods_img'],$path_to.'goods_img/'.$ret['goods_img']);	}else{		$ret['goods_img'] = $names[0].'_240.'.$names[1];		@copy($path_source.$ret['goods_img'],$path_to.'goods_img/'.$ret['goods_img']);	}	return $ret;}exit;*//*//导入会员表//首先修改一下ecs_users 表中的索引$sql = "ALTER TABLE ecs_users DROP INDEX `user_name` ,ADD INDEX `user_name` ( `user_name` ) ";$db->query($sql);//导入原本的数据$sql = "INSERT INTO ecs_users (user_id,email,user_name,password,surplus_password,sex,birthday,reg_time,last_login,last_time,last_ip,msn,qq,mobile_phone,real_name,headimg) SELECT member_id,member_email,member_name,member_passwd,member_paypwd,member_sex,member_birthday,member_time,member_old_login_time,member_old_login_time,member_old_login_ip,'',member_qq,member_mobile,member_truename,member_avatar from shopnc_member;";$db->query($sql);$sql = "select user_name,password,is_surplus_open,surplus_password,headimg from ecs_users group by user_name";$query = $db->query($sql);while($row = $db->fetchRow($query)){	$update = array();	$update['password'] = md5($row['user_name'].'login');	if($row['surplus_password']){		$update['is_surplus_open'] = 1;		$update['surplus_password'] = md5($row['user_name'].'pay');	}	if($row['headimg']){		//$update['headimg'] = 'data/headimg/201508/'.$row['headimg'];		$update['headimg'] = '';	}	$db->autoExecute('ecs_users', $update, 'UPDATE', "user_name = '".$row['user_name']."'");}//删除会员中的重复会员$sql = "SELECT count(user_name) as num ,user_name from ecs_users group by user_name order by num desc";$query = $db->query($sql);while($row = $db->fetchRow($query)){	if($row['num']>1){		//删除重复的用户名		$delet_num = $row['num'] - 1;		$db->query("delete from ecs_users where user_name='".$row['user_name']."' limit ".$delet_num);	}}$sql = "ALTER TABLE `ecs_users` DROP INDEX `user_name` ,ADD UNIQUE `user_name` ( `user_name` ) ";$db->query($sql);exit;*/?>